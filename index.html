<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SaneGames</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        background-color: #1e293b;
        color: white;
        font-family: 'Arial', sans-serif;
      }

      .loader {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .loader > * {
        margin: 0.5em 0;
      }

      input[type='text'] {
        padding: 0.75em;
        border: none;
        border-radius: 0.5em;
        font-size: 1em;
        background-color: #334155;
        color: white;
        margin-bottom: 1em;
      }

      button {
        padding: 0.75em 1.5em;
        border: none;
        border-radius: 0.5em;
        background-color: #6842FF;
        color: white;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #714ff7;
      }

      .css-inwm4l,
      .css-13yk3gq,
      #qr-modal-toggle-button,
      a[
        href='https://www.crazygames.com/?utm_source=https%3A%2F%2Fsanegames.vercel.app%2F&utm_medium=game_frame&utm_content=logo'
      ] {
        display: none !important;
      }

      #gameInput {
        display: none;
      }

      #gameInput.active {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      a {
        color: #6842ff;
      }

      #recommendationsPopup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #334155;
        color: white;
        padding: 20px;
        border-radius: 0.5em;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        width: 80%;
        max-width: 600px;
      }

      #recommendationsPopup h2 {
        margin-top: 0;
      }

      #recommendationsPopup ul {
        list-style-type: none;
        padding: 0;
      }

      #recommendationsPopup li {
        margin-bottom: 0.5em;
      }

      #recommendationsPopup a {
        color: #6842ff;
        text-decoration: none;
      }

      #recommendationsPopup a:hover {
        text-decoration: underline;
      }

      #recommendationsPopup.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="loader" id="loader">Loadingâ€¦</div>

    <div class="loader" id="gameInput">
      <h1>Welcome to <b>SaneGames.</b></h1>
      <h3>
        A better client for all
        <a href="https://www.crazygames.com/" target="_blank">CrazyGames</a>
        games, with no ads or annoying UI.
      </h3>
      <p>
        You have not set a slug! So please proceed to the main
        <a href="https://www.crazygames.com/" target="_blank">CrazyGames</a>
        website, find a game, and then copy the game slug in the URL (e.g.,
        crazy-flips-3d) and put it below.
        <a onclick="recommendations()">Game Recommendations</a>
      </p>
      <input type="text" placeholder="crazy-flips-3d" id="gameSlugInput" />
      <button onclick="loadGameFromInput()">Play Game</button>
    </div>

    <div id="recommendationsPopup">
      <h2>Game Recommendations</h2>
      <ul>
        <li>
          <a
            href="?game=moto-x3m"
            target="_blank"
            onclick="closeRecommendations()"
            >Moto X3M</a
          >
        </li>
        <li>
          <a
            href="?game=basket-random"
            target="_blank"
            onclick="closeRecommendations()"
            >Basket Random</a
          >
        </li>
        <li>
          <a
            href="?game=evo-world-io"
            target="_blank"
            onclick="closeRecommendations()"
            >EvoWorld.io (FlyOrDie)</a
          >
        </li>
      </ul>
    </div>

    <script>
      const adBlockList = [
        'doubleclick.net',
        'adservice.google.com',
        'googlesyndication.com',
        'ads.crazygames.com',
        'pagead2.googlesyndication.com',
        'securepubads.g.doubleclick.net',
        'cpx.to',
        'adnxs.com',
        'googletagmanager.com',
        'imasdk.googleapis.com',
      ];

      (function blockAds() {
        let originalFetch = window.fetch;
        window.fetch = async function (...args) {
          if (adBlockList.some(domain => args[0].includes(domain))) {
            console.warn('Blocked ad request:', args[0]);
            return new Response(null, { status: 403, statusText: 'Blocked' });
          }
          return originalFetch(...args);
        };

        let originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function (method, url) {
          if (adBlockList.some(domain => url.includes(domain))) {
            console.warn('Blocked ad request:', url);
            return;
          }
          return originalOpen.apply(this, arguments);
        };
      })();

      function removeAds() {
        document.querySelectorAll('iframe, script, div').forEach(el => {
          if (adBlockList.some(domain => el.src && el.src.includes(domain))) {
            el.remove();
            console.warn('Removed ad element:', el);
          }
        });
      }

      const observer = new MutationObserver(mutations => {
        mutations.forEach(() => removeAds());
      });

      observer.observe(document.body, { childList: true, subtree: true });

      async function fetchWithTimeout(url, timeout = 3000) {
        return Promise.race([
          fetch(url),
          new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Timeout')), timeout),
          ),
        ]);
      }

      async function fetchGameConfig(gameSlug) {
        try {
          let response = await fetchWithTimeout(
            `https://opencors.netlify.app/.netlify/functions/main?url=${encodeURIComponent(
              `https://games.crazygames.com/en_US/${gameSlug}/index.html`,
            )}`,
          );
          let text = await response.text();
          let match = text.match(/var options = (\{[\s\S]*?\});/);
          return match ? JSON.parse(match[1]) : null;
        } catch (error) {
          console.warn('Primary fetch failed, attempting fallback:', error);
          try {
            let response = await fetchWithTimeout(
              `https://corsproxy.io/?key=d6168cb0&url=${encodeURIComponent(
                `https://games.crazygames.com/en_US/${gameSlug}/index.html`,
              )}`,
            );
            let text = await response.text();
            let match = text.match(/var options = (\{[\s\S]*?\});/);
            return match ? JSON.parse(match[1]) : null;
          } catch (error) {
            console.error('Fallback fetch failed:', error);
            return null;
          }
        }
      }

      async function loadGame() {
        let params = new URLSearchParams(window.location.search);
        let gameSlug = params.get('game');
        let loader = document.getElementById('loader');
        let gameInput = document.getElementById('gameInput');

        if (!gameSlug) {
          loader.style.display = 'none';
          gameInput.classList.add('active');
          return;
        }

        let options = await fetchGameConfig(gameSlug);
        if (!options) {
          loader.textContent =
            "Loading failed. Either there's some error, or, most likely, you mistyped the slug.";
          return;
        }

        let script = document.createElement('script');
        script.src = 'https://builds.crazygames.com/gameframe/v1/bundle.js';
        script.onload = () => {
          if (window.Crazygames) {
            Crazygames.load(options).then(() => {
              loader.remove();
              gameInput.remove();
            });
          } else {
            console.error('Crazygames SDK failed to load.');
          }
        };
        document.head.appendChild(script);
      }

      function loadGameFromInput() {
        let gameSlug = document.getElementById('gameSlugInput').value;
        if (gameSlug) {
          let newUrl = window.location.href.split('?')[0] + '?game=' + gameSlug;
          window.location.href = newUrl;
        }
      }

      function recommendations() {
        const popup = document.getElementById('recommendationsPopup');
        popup.classList.add('active');
      }

      function closeRecommendations() {
        const popup = document.getElementById('recommendationsPopup');
        popup.classList.remove('active');
      }

      window.onclick = function (event) {
        const popup = document.getElementById('recommendationsPopup');
        if (
          event.target == popup &&
          popup.classList.contains('active') === true
        ) {
          closeRecommendations();
        }
      };

      loadGame();
    </script>
  </body>
</html>